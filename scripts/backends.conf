#!/bin/bash

# ==============================================================================
# Centralized Backend Configuration for neuriplo
# ==============================================================================
#
# This file works in conjunction with versions.env to maintain a complete
# backend configuration system. Together, these files provide:
#
#   backends.conf (this file) → Defines backend metadata (names, paths, executables)
#   versions.env              → Defines backend version numbers
#
# RELATIONSHIP WITH versions.env:
# ------------------------------
# Each backend defined here must have a corresponding version variable in
# versions.env. The validation system automatically checks this consistency.
#
# Example pairing:
#   backends.conf:  "TVM|tvm|TVMInferTest|TVM_VERSION"
#   versions.env:   TVM_VERSION=0.18.0
#
# HOW TO ADD A NEW BACKEND:
# -------------------------
# 1. Add ONE line to BACKEND_DEFINITIONS array below:
#      "BACKEND_NAME|directory-name|TestExecutableName|VERSION_VAR_NAME"
#
#    Example:  "NCNN|ncnn|NCNNInferTest|NCNN_VERSION"
#
# 2. Add the version to versions.env (must match VERSION_VAR_NAME):
#      NCNN_VERSION=1.0.34
#
# 3. Add the version cache to cmake/versions.cmake:
#      set(NCNN_VERSION "${NCNN_VERSION}" CACHE STRING "NCNN version")
#
# 4. Add backend availability check in scripts/test_backends.sh:
#      Add case in check_backend_availability() function
#
# 5. Create backend implementation:
#      backends/ncnn/src/NCNNInfer.cpp
#      backends/ncnn/src/NCNNInfer.hpp
#      backends/ncnn/test/NCNNInferTest.cpp
#
# VALIDATION:
# -----------
# Both bash scripts and CMake automatically validate that:
#   • Every backend has a corresponding version variable
#   • All version variables are defined in versions.env
#   • The mapping is correct and consistent
#
# Run validation manually:
#   Bash:  source scripts/backends.conf && validate_backend_versions
#   CMake: cmake .. (validation runs automatically during configuration)
#
# ==============================================================================

# Backend Definitions
# Format: "BACKEND_NAME|directory-name|TestExecutableName|VERSION_VAR_NAME"
BACKEND_DEFINITIONS=(
    "OPENCV_DNN|opencv-dnn|OCVDNNInferTest|OPENCV_VERSION"
    "ONNX_RUNTIME|onnx-runtime|ONNXRuntimeInferTest|ONNX_RUNTIME_VERSION"
    "LIBTORCH|libtorch|LibtorchInferTest|PYTORCH_VERSION"
    "LIBTENSORFLOW|libtensorflow|TensorFlowInferTest|TENSORFLOW_VERSION"
    "TENSORRT|tensorrt|TensorRTInferTest|TENSORRT_VERSION"
    "OPENVINO|openvino|OpenVINOInferTest|OPENVINO_VERSION"
    "GGML|ggml|GGMLInferTest|GGML_VERSION"
    "TVM|tvm|TVMInferTest|TVM_VERSION"
)

# ==============================================================================
# Auto-generated arrays and mappings (DO NOT EDIT BELOW THIS LINE)
# ==============================================================================

# Parse definitions into arrays and associative arrays
BACKENDS=()
declare -A BACKEND_DIRS
declare -A BACKEND_TEST_EXES
declare -A BACKEND_VERSION_VARS

for def in "${BACKEND_DEFINITIONS[@]}"; do
    IFS='|' read -r name dir exe ver <<< "$def"
    BACKENDS+=("$name")
    BACKEND_DIRS["$name"]="$dir"
    BACKEND_TEST_EXES["$name"]="$exe"
    BACKEND_VERSION_VARS["$name"]="$ver"
done

# Function to get backend directory name
get_backend_dir() {
    local backend=$1
    echo "${BACKEND_DIRS[$backend]:-unknown}"
}

# Function to get test executable name
get_test_executable_name() {
    local backend=$1
    echo "${BACKEND_TEST_EXES[$backend]:-UnknownInferTest}"
}

# Function to get backend list as space-separated string
get_backends_list() {
    echo "${BACKENDS[@]}"
}

# Function to check if a backend is supported
is_backend_supported() {
    local backend=$1
    for supported_backend in "${BACKENDS[@]}"; do
        if [ "$supported_backend" = "$backend" ]; then
            return 0
        fi
    done
    return 1
}

# Function to validate backend-version consistency
validate_backend_versions() {
    local project_root="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
    local versions_file="$project_root/versions.env"

    if [ ! -f "$versions_file" ]; then
        echo "Warning: versions.env not found at $versions_file"
        return 1
    fi

    # Source versions.env
    source "$versions_file"

    local validation_failed=0
    local missing_versions=()

    echo "=== Validating Backend-Version Consistency ==="

    for backend in "${BACKENDS[@]}"; do
        local version_var="${BACKEND_VERSION_VARS[$backend]}"
        local version_value="${!version_var}"  # Indirect variable expansion

        if [ -z "$version_value" ]; then
            echo "  ✗ $backend -> $version_var is MISSING"
            missing_versions+=("$backend ($version_var)")
            validation_failed=1
        else
            echo "  ✓ $backend -> $version_var = $version_value"
        fi
    done

    if [ $validation_failed -eq 1 ]; then
        echo ""
        echo "=== Backend-Version Validation FAILED ==="
        echo "Missing version variables in versions.env:"
        for missing in "${missing_versions[@]}"; do
            echo "  - $missing"
        done
        echo ""
        echo "Please add the missing version variables to versions.env"
        return 1
    else
        echo "=== Backend-Version Validation PASSED ==="
        return 0
    fi
}
